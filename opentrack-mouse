#!/bin/bash
# Control script for opentrack mouse

check_running() {
    if [ -f /tmp/opentrack_mouse.pid ]; then
        PID=$(tail -1 /tmp/opentrack_mouse.pid)
        if kill -0 $PID 2>/dev/null; then
            return 0
        fi
    fi
    return 1
}

start_tracker() {
    echo "Starting head tracker..."
    nohup opentrack-mouse-tracker > /dev/null 2>&1 &
    # Wait for PID file to be created
    for i in {1..10}; do
        sleep 1
        if [ -f /tmp/opentrack_mouse.pid ]; then
            sleep 1  # Extra second for stability
            return 0
        fi
    done
    return 1
}

case "$1" in
    toggle)
        if ! check_running; then
            start_tracker
        fi
        if check_running; then
            PID=$(tail -1 /tmp/opentrack_mouse.pid)
            kill -SIGUSR1 $PID && echo "Toggled head tracking"
        else
            echo "Failed to start tracker"
        fi
        ;;
    calibrate)
        if ! check_running; then
            start_tracker
        fi
        if check_running; then
            PID=$(tail -1 /tmp/opentrack_mouse.pid)
            kill -SIGUSR2 $PID && echo "Recalibration started..."
        else
            echo "Failed to start tracker"
        fi
        ;;
    status)
        if check_running; then
            echo "Head tracking is running (PID: $(tail -1 /tmp/opentrack_mouse.pid))"
            if [ -f ~/.config/headmouse/calibration.json ]; then
                echo "Calibration file: ~/.config/headmouse/calibration.json"
            else
                echo "No calibration file found"
            fi
        else
            echo "Head tracking is not running"
        fi
        ;;
    *)
        echo "Usage: opentrack-mouse {toggle|calibrate|status}"
        echo "  toggle     - Toggle head tracking on/off (starts tracker if needed)"
        echo "  calibrate  - Trigger live recalibration (starts tracker if needed)"
        echo "  status     - Check if tracker is running"
        ;;
esac
